@model List<FashionStore.Models.Order>
@using FashionStore.Models
@{
    ViewBag.Title = "Đơn hàng của tôi";
    
    Func<string, string> GetStatusText = (status) =>
    {
        switch (status)
        {
            case "Pending": return "Chờ xác nhận";
            case "Confirmed": return "Đã xác nhận";
            case "Processing": return "Đang xử lý";
            case "Shipping": return "Đang giao hàng";
            case "Delivered": return "Đã giao hàng";
            case "Cancelled": return "Đã hủy";
            case "Returned": return "Đã hoàn trả";
            default: return status;
        }
    };
    
    Func<string, string> GetStatusClass = (status) =>
    {
        switch (status)
        {
            case "Pending": return "warning";
            case "Processing": return "primary";
            case "Shipped": return "info";
            case "Completed": return "sucess";
            case "Cancelled": return "danger";
            default: return "secondary";
        }
    };
    
    Func<string, string> GetStatusIcon = (status) =>
    {
        switch (status)
        {
            case "Delivered": return "bi-check-circle-fill";
            case "Shipping": return "bi-truck";
            case "Processing": return "bi-hourglass-split";
            case "Confirmed": return "bi-clipboard-check";
            case "Cancelled": return "bi-x-circle-fill";
            case "Returned": return "bi-arrow-return-left";
            default: return "bi-clock-fill";
        }
    };
}


<section id="orders" class="py-5">
    <div class="container">
        

        @if (Model == null || !Model.Any())
        {
            <!-- Empty State -->
            <div class="text-center py-5">
                <i class="bi bi-bag-x" style="font-size: 5rem; color: #ccc;"></i>
                <h4 class="mt-3 text-muted">Không có đơn hàng nào</h4>
                <p class="text-muted m-0">
                    <text>Bạn chưa có đơn hàng nào. Hãy bắt đầu mua sắm!</text>
                </p>
                <a href="@Url.Action("Index", "Product")" class="btn btn-primary btn-lg btn-rounded-none fs-6 mt-3">
                    <i class="bi bi-shop me-2"></i>Khám phá sản phẩm
                </a>
            </div>
        }
        else
        {
            
            <!-- Page Title -->
            <div class="mb-4">
                <h1 class="display-6 mb-2">Đơn hàng của tôi</h1>
                <p class="text-muted fs-5">Quản lý và theo dõi tất cả đơn hàng của bạn</p>
            </div>

            <!-- Filter Tabs -->
            <div class="mb-4">
                <ul class="nav nav-pills">
                    <li class="nav-item">
                        <a class="nav-link @(string.IsNullOrEmpty(ViewBag.CurrentStatus) ? "active" : "")"
                           href="@Url.Action("Index")">
                            <i class="bi bi-list-ul me-2"></i>Tất cả
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link @(ViewBag.CurrentStatus == "Pending" ? "active" : "")"
                           href="@Url.Action("Index", new { status = "Pending" })">
                            <i class="bi bi-clock me-2"></i>Chờ xác nhận
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link @(ViewBag.CurrentStatus == "Shipping" ? "active" : "")"
                           href="@Url.Action("Index", new { status = "Shipping" })">
                            <i class="bi bi-truck me-2"></i>Đang giao
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link @(ViewBag.CurrentStatus == "Delivered" ? "active" : "")"
                           href="@Url.Action("Index", new { status = "Delivered" })">
                            <i class="bi bi-check-circle me-2"></i>Đã giao
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link @(ViewBag.CurrentStatus == "Cancelled" ? "active" : "")"
                           href="@Url.Action("Index", new { status = "Cancelled" })">
                            <i class="bi bi-x-circle me-2"></i>Đã hủy
                        </a>
                    </li>
                </ul>
            </div>
        <!-- Orders Accordion -->
        <div class="accordion" id="ordersAccordion">
            @for (int i = 0; i < Model.Count; i++)
            {
                var order = Model[i];
                var statusClass = GetStatusClass(order.Status);
                var statusIcon = GetStatusIcon(order.Status);
                var statusText = GetStatusText(order.Status);
                var accordionId = "order-" + order.OrderID;

                <div class="accordion-item mb-3 border shadow-sm rounded">
                    <h2 class="accordion-header" id="heading-@order.OrderID">
                        <button class="accordion-button @(i == 0 ? "" : "collapsed")"
                                type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#@accordionId"
                                aria-expanded="@(i == 0 ? "true" : "false")"
                                aria-controls="@accordionId">
                            <div class="w-100 d-flex justify-content-between align-items-center pe-3">
                                <div>
                                    <div class="fs-5 mb-1">
                                        Đơn hàng #@order.OrderID
                                    </div>
                                    <div class="small text-muted">
                                        <i class="bi bi-calendar3 me-1"></i>
                                        @order.OrderDate.Value.ToShortDateString()
                                        <span class="mx-2">|</span>
                                        <i class="bi bi-box-seam me-1"></i>
                                        @order.OrderDetails.Count sản phẩm
                                    </div>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-@statusClass px-3 py-2 fs-6 mb-2 fw-light">
                                        <i class="bi @statusIcon me-1"></i>
                                        @statusText
                                    </span>
                                    <div class="fw-bold fs-4 " style="font-family: Roboto">
                                        @order.TotalAmount.ToString("N0")đ
                                    </div>
                                </div>
                            </div>
                        </button>
                    </h2>
                    <div id="@accordionId"
                         class="accordion-collapse collapse @(i == 0 ? "show" : "")"
                         aria-labelledby="heading-@order.OrderID"
                         data-bs-parent="#ordersAccordion">
                        <div class="accordion-body">
                            <!-- Order Info -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="card bg-light border-0">
                                        <div class="card-body">
                                            <h6 class=" mb-3">
                                                <i class="bi bi-geo-alt text-primary me-2"></i>
                                                Địa chỉ giao hàng
                                            </h6>
                                            <p class="mb-0">@order.ShippingAddress</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mt-3 mt-md-0">
                                    <div class="card bg-light border-0">
                                        <div class="card-body">
                                            <h6 class=" mb-3">
                                                <i class="bi bi-credit-card text-primary me-2"></i>
                                                Thanh toán
                                            </h6>
                                            <p class="mb-0">@order.PaymentMethod</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Order Items -->
                            <h6 class=" mb-3">
                                <i class="bi bi-bag-check text-primary me-2"></i>
                                Chi tiết sản phẩm
                            </h6>
                            <div class="table-responsive">
                                <table class="table table-hover align-middle">
                                    <thead class="table-light">
                                    <tr>
                                        <th width="50%">Sản phẩm</th>
                                        <th class="text-center">Đơn giá</th>
                                        <th class="text-center">Số lượng</th>
                                        <th class="text-end">Thành tiền</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    @foreach (var detail in order.OrderDetails)
                                    {
                                        var product = detail.ProductVariant.Product;
                                        var primaryImage = product?.ProductImages.FirstOrDefault(img => img.IsPrimary == true);
                                        var itemTotal = detail.Price * detail.Quantity * (1 - (detail.DiscountPercent ?? 0) / 100);

                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="me-3" style="width: 80px; height: 80px;">
                                                        <img src="@Url.Content("~/Content/img/products/" + (primaryImage?.ImageUrl ?? "default.jpg"))"
                                                             alt="@product.ProductName"
                                                             class="img-fluid rounded"
                                                             style="width: 100%; height: 100%; object-fit: cover;">
                                                    </div>
                                                    <div>
                                                        <h6 class="mb-1 ">@product.ProductName</h6>
                                                        <div class="small text-muted">
                                                            <span>Màu: <strong>@detail.ProductVariant.Color.ColorName</strong></span>
                                                            <span class="mx-2">|</span>
                                                            <span>Size: <strong>@detail.ProductVariant.Size.SizeName</strong></span>
                                                        </div>
                                                        @if (detail.DiscountPercent > 0)
                                                        {
                                                            <span class="badge bg-danger mt-1">-@detail.DiscountPercent.Value.ToString("N0")%</span>
                                                        }
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="text-center">
                                                @if (detail.DiscountPercent > 0)
                                                {
                                                    <div class="text-muted text-decoration-line-through small">
                                                        @detail.Price.ToString("N0")đ
                                                    </div>
                                                    <div class="">
                                                        @((detail.Price * (1 - detail.DiscountPercent.Value / 100)).ToString("N0"))đ
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="">@detail.Price.ToString("N0")đ</div>
                                                }
                                            </td>
                                            <td class="text-center">
                                                <span class="">@detail.Quantity</span>
                                            </td>
                                            <td class="text-end">
                                                <div class="fs-5">
                                                    @itemTotal.ToString("N0")đ
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                    </tbody>
                                    <tfoot>
                                    <tr class="table-light">
                                        <td colspan="3" class="text-end  fs-5">Tổng cộng:</td>
                                        <td class="text-end  fw-bold fs-4">
                                            @order.TotalAmount.ToString("N0")đ
                                        </td>
                                    </tr>
                                    </tfoot>
                                </table>
                            </div>

                            <!-- Action Buttons -->
                            <div class="d-flex gap-2 mt-4">
                                @if (order.Status == OrderStatus.Pending.ToString() || order.Status == OrderStatus.Processing.ToString())
                                {
                                    using (Html.BeginForm("Cancel", "Order", new { id = order.OrderID }, FormMethod.Post, new { @class = "d-inline", onsubmit = "return confirm('Bạn có chắc muốn hủy đơn hàng này?');" }))
                                    {
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="btn btn-danger">
                                            <i class="bi bi-x-circle me-2"></i>Hủy đơn hàng
                                        </button>
                                    }
                                }
                                @if (order.Status == "Delivered")
                                {
                                    <a href="@Url.Action("Review", "Order", new { id = order.OrderID })"
                                       class="btn btn-warning">
                                        <i class="bi bi-star me-2"></i>Đánh giá
                                    </a>
                                    <a href="@Url.Action("BuyAgain", "Order", new { id = order.OrderID })"
                                       class="btn btn-success">
                                        <i class="bi bi-cart-plus me-2"></i>Mua lại
                                    </a>
                                }
                                <a href="#" class="btn btn-outline-primary ms-auto" onclick="window.print(); return false;">
                                    <i class="bi bi-printer me-2"></i>In hóa đơn
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
        }
    </div>
</section>

@section styles
{
    <link rel="stylesheet" href="~/Content/css/order.css"/>
}