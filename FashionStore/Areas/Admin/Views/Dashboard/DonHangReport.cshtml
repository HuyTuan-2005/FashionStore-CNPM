@model IEnumerable<FashionStore.Models.Order>
@{
    ViewBag.Title = "Báo cáo đơn hàng";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}

<style>
    .chart-wrapper {
        position: relative;
        min-height: 320px;
    }
</style>

<div class="container-fluid mt-4">
    <div class="mb-2">
        <a href="@Url.Action("Index", "Dashboard")" class="btn btn-link btn-sm text-decoration-none text-muted p-0">
            <i class="fas fa-long-arrow-alt-left me-1"></i> Quay lại
        </a>
    </div>
    <h4 class="fw-bold mb-3">📦 BÁO CÁO ĐƠN HÀNG</h4>

    <!-- FILTER -->
    <form method="get" class="row g-2 mb-4">
        <div class="col-md-3">
            <input type="date" name="fromDate" value="@ViewBag.FromDate" class="form-control">
        </div>
        <div class="col-md-3">
            <input type="date" name="toDate" value="@ViewBag.ToDate" class="form-control">
        </div>
        <div class="col-md-2">
            <button class="btn btn-success w-100">Lọc</button>
        </div>
    </form>

    <!-- CHART -->
    <div class="card shadow mb-4">
        <div class="card-header fw-bold">Số đơn theo ngày</div>
        <div class="card-body">
            <div class="chart-wrapper">
                <canvas id="ordersChart"></canvas>
            </div>
        </div>
    </div>

    <!-- TABLE -->
    <div class="card shadow">
        <div class="card-header fw-bold">Danh sách đơn hàng</div>
        <div class="table-responsive">
            <table class="table table-bordered table-sm">
                <thead class="table-light">
                    <tr>
                        <th>#</th>
                        <th>Ngày</th>
                        <th>Khách</th>
                        <th>Trạng thái</th>
                        <th class="text-end">Tổng</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        int i = 1;
                        foreach (var o in Model ?? Enumerable.Empty<FashionStore.Models.Order>())
                        {
                            <tr>
                                <td>@i</td>
                                <td>@o.OrderDate</td>
                                <td>@(o.Customer?.UserName ?? "N/A")</td>
                                <td>@o.Status</td>
                                <td class="text-end">@String.Format("{0:N0}", o.TotalAmount)</td>
                            </tr>
                            i++;
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@section scripts{
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    $.getJSON('@Url.Action("OrdersByDay","Dashboard")', {
        fromDate: '@ViewBag.FromDate',
        toDate: '@ViewBag.ToDate'
    }, function(res) {
        // Cấu hình nhãn và màu sắc tương ứng cho từng thuộc tính từ JSON
        const statusMap = [
            { key: 'Pending', label: 'Chờ xử lý', color: '#ffc107' },      // Vàng
            { key: 'Processing', label: 'Đang đóng gói', color: '#17a2b8' }, // Xanh lá mạ/Xanh biển nhạt
            { key: 'Shipped', label: 'Đang giao', color: '#007bff' },      // Xanh dương
            { key: 'Completed', label: 'Hoàn thành', color: '#28a745' },    // Xanh lá
            { key: 'Cancelled', label: 'Đã hủy', color: '#dc3545' },       // Đỏ
            { key: 'Chothanhtoan', label: 'Chờ thanh toán', color: '#6c757d' } // Xám
        ];

        const datasets = statusMap.map(s => ({
            label: s.label,
            data: res.map(x => x[s.key]),
            backgroundColor: s.color,
            borderColor: s.color,
            borderWidth: 1
        }));

        new Chart(document.getElementById('ordersChart'), {
            type: 'bar',
            data: {
                labels: res.map(x => x.Date),
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { stacked: true },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        ticks: { stepSize: 1 }
                    }
                }
            }
        });
    });
    </script>
}